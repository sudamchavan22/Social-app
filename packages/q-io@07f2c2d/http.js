var HTTP=require("http"),HTTPS=require("https"),URL=require("url2"),Q=require("q"),Reader=require("./reader");exports.Server=function(e){var t=Object.create(exports.Server.prototype),n=HTTP.createServer(function(t,n){var r=exports.ServerRequest(t),i=exports.ServerResponse(n),a=Q.defer();t.on("end",function(e,t){e?a.reject(e):a.resolve(t)}),Q.when(r,function(t){return Q.when(e(t,i),function(e){return e?(n.writeHead(e.status,e.headers),(e.onclose||e.onClose)&&Q.when(a,e.onclose||e.onClose),Q.when(e.body,function(t){var r;if(Array.isArray(t)&&(r=t.length)&&t.every(function(e){return"string"==typeof e}))t.forEach(function(t,i){r-1>i?n.write(t,e.charset):n.end(t,e.charset)});else{if(t){var i,a=t.forEach(function(t){i=Q.when(i,function(){return Q.when(t,function(t){n.write(t,e.charset)})})});return Q.when(a,function(){return Q.when(i,function(){n.end()})})}n.end()}})):void 0})}).done()}),r=Q.defer();n.on("close",function(e){e?r.reject(e):r.resolve()}),t.stop=function(){return n.close(),i=void 0,r.promise};var i=Q.defer();return n.on("listening",function(e){e?i.reject(e):i.resolve(t)}),t.listen=function(){return n.port!==void 0?Q.reject(Error("A server cannot be restarted or started on a new port")):(n.listen.apply(n,arguments),i.promise)},t.stopped=r.promise,t.node=n,t.nodeServer=n,t.address=n.address.bind(n),t},Object.defineProperties(exports.Server,{port:{get:function(){return this.node.port}},host:{get:function(){return this.node.host}}}),exports.ServerRequest=function(e,t){var n=Object.create(e,requestDescriptor);n.version=e.httpVersion.split(".").map(Math.floor),n.method=e.method,n.path=e.url,n._pathInfo=null,n.scriptName="",n.scheme="http";var r=e.connection.address();n.hostname=e.headers.host?e.headers.host.split(":")[0]:r.address,n.port=r.port;var i=n.port===(t?443:80);n.host=n.hostname+(i?"":":"+n.port);var a=e.socket;return n.remoteHost=a.remoteAddress,n.remotePort=a.remotePort,n.url=URL.format({protocol:n.scheme,host:e.headers.host,port:n.port===(t?443:80)?null:n.port,path:n.path}),n.body=Reader(e),n.headers=e.headers,n.node=e,n.nodeRequest=e,n.nodeConnection=e.connection,Q.when(n.body,function(e){return n.body=e,n})};var requestDescriptor={pathInfo:{get:function(){return null===this._pathInfo&&(this._pathInfo=decodeURIComponent(URL.parse(this.url).pathname)),this._pathInfo},set:function(e){this._pathInfo=e}}};exports.ServerResponse=function(e,t){var n=Object.create(e);return n.ssl=t,n.node=e,n.nodeResponse=e,n},exports.normalizeRequest=function(e){if("string"==typeof e&&(e={url:e}),e.method=e.method||"GET",e.headers=e.headers||{},e.url){var t=URL.parse(e.url);e.ssl="https:"===t.protocol,e.hostname=t.hostname,e.host=t.host,e.port=+t.port,e.path=(t.pathname||"")+(t.search||""),e.auth=t.auth||void 0}if(e.host=e.host||e.headers.host,e.port=e.port||(e.ssl?443:80),e.host&&!e.hostname&&(e.hostname=e.host.split(":")[0]),e.hostname&&e.port&&!e.host){var n=e.ssl?443:80;e.host=e.hostname+(n?"":":"+e.port)}return e.headers.host=e.headers.host||e.host,e.path=e.path||"/",e},exports.normalizeResponse=function(e){return void 0!==e?("string"==typeof e&&(e=[e]),e.forEach&&(e={status:200,headers:{},body:e}),e):void 0},exports.request=function(e){return Q.when(e,function(e){e=exports.normalizeRequest(e);var t=Q.defer(),n=e.ssl?HTTPS:HTTP,r={hostname:e.hostname,port:e.port||(e.ssl?443:80),localAddress:e.localAddress,socketPath:e.socketPath,method:e.method,path:e.path,headers:e.headers,auth:e.auth};void 0!==e.agent&&(r.agent=e.agent);var i=n.request(r,function(n){t.resolve(exports.ClientResponse(n,e.charset)),n.on("error",function(e){console.warn(e&&e.stack||e),t.reject(e)})});return i.on("error",function(e){t.reject(e)}),Q.when(e.body,function(t){var n,r;return t&&(r=t.forEach(function(t){n=Q.when(n,function(){return Q.when(t,function(t){i.write(t,e.charset)})})})),Q.when(n,function(){return Q.when(r,function(){i.end()})})}).done(),t.promise})},exports.read=function(e,t){return t=t||function(e){return 200===e.status},Q.when(exports.request(e),function(e){if(!t(e)){var n=Error("HTTP request failed with code "+e.status);throw n.response=e,n}return Q.post(e.body,"read",[])})},exports.ClientResponse=function(e,t){var n=Object.create(exports.ClientResponse.prototype);return n.status=e.statusCode,n.version=e.httpVersion,n.headers=e.headers,n.node=e,n.nodeResponse=e,n.nodeConnection=e.connection,Q.when(Reader(e,t),function(e){return n.body=e,n})};