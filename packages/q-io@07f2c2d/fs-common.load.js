montageDefine("07f2c2d","fs-common",{dependencies:["q","./fs-boot","./fs-root","./fs-mock"],factory:function(e,t){var n=e("q"),r=e("./fs-boot"),i=e("./fs-root"),a=e("./fs-mock"),s=function(e){return Array.prototype.concat.apply([],e)};t.update=function(e,t){function o(e){var t=this;return e=e||this.ROOT,i(t,e)}function l(e){this.node=e,this.size=e.size}for(var c in r)e[c]=r[c];e.read=function(e,t,r,i){return"object"==typeof t?i=t:"object"==typeof r?(i=r,i.flags=t):(i=i||{},i.flags=t,i.charset=r),i.flags=i.flags||"r",n.when(this.open(e,i),function(e){return e.read()},function(n){throw n.message="Can't read "+e+" because "+n.message,n.path=e,n.flags=t,n.charset=r,n})},e.write=function(e,t,r,i,a){var s=this;return"object"==typeof r?a=r:"object"==typeof i?(a=i,a.flags=r):(a=a||{},a.flags=r,a.charset=i),r=a.flags||"w",-1!==r.indexOf("b")?t instanceof Buffer||(t=new Buffer(t)):t instanceof Buffer&&(r+="b"),a.flags=r,n.when(s.open(e,a),function(e){return n.when(e.write(t),function(){return e.close()})})},e.append=function(e,t,r,i,a){var s=this;return"object"==typeof r?a=r:"object"==typeof i?(a=i,a.flags=r):(a=a||{},a.flags=r,a.charset=i),r=a.flags||"a",t instanceof Buffer&&(r+="b"),a.flags=r,n.when(s.open(e,a),function(e){return n.when(e.write(t),function(){return e.close()})})},e.move=function(e,t){var n=this;return this.rename(e,t).catch(function(r){if(r.crossDevice)return n.copyTree(e,t).then(function(){return n.removeTree(e)});throw r})},e.copy=function(e,t){var r=this;return n.when(r.stat(e),function(i){var a=i.node.mode;return n.all([r.open(e,{flags:"rb"}),r.open(t,{flags:"wb",mode:a})])}).spread(function(e,t){return n.when(e.forEach(function(e){return t.write(e)}),function(){return n.all([e.close(),t.close()])})})},e.copyTree=function(e,t){var r=this;return n.when(r.stat(e),function(i){return i.isFile()?r.copy(e,t):i.isDirectory()?r.exists(t).then(function(a){function s(){return n.when(r.list(e),function(i){return n.all(i.map(function(n){return r.copyTree(r.join(e,n),r.join(t,n))}))})}return a?s():n.when(r.makeDirectory(t,i.node.mode),s)}):i.isSymbolicLink()?r.symbolicCopy(e,t):void 0})},e.listTree=function(e,t){var r=this;e=(e||"")+"",e||(e="."),t=t||function(){return!0};var i=r.stat(e);return n.when(i,function(i){var a=[];try{var s=t(e,i)}catch(o){return n.reject(o)}return n.when(s,function(s){return s&&a.push([e]),null!==s&&i.isDirectory()?n.when(r.list(e),function(n){return a.push.apply(a,n.map(function(n){var i=r.join(e,n);return r.listTree(i,t)})),a}):a})},function(){return[]}).then(n.all).then(s)},e.listDirectoryTree=function(e){return this.listTree(e,function(e,t){return t.isDirectory()})},e.makeTree=function(e,t){e+="";var r=this,i=r.split(e),a=[];return r.isAbsolute(e)&&a.push(i.shift()||r.ROOT),i.reduce(function(e,i){return n.when(e,function(){a.push(i);var e=r.join(a)||".",s=r.makeDirectory(e,t);return n.when(s,null,function(e){if(!e.exists)throw e})})},void 0)},e.removeTree=function(e){var t=this;return n.when(t.statLink(e),function(r){return r.isSymbolicLink()?t.remove(e):r.isDirectory()?t.list(e).then(function(r){return n.all(r.map(function(n){return t.removeTree(t.join(e,n))})).then(function(){return t.removeDirectory(e)})}):t.remove(e)})},e.symbolicCopy=function(e,t,r){var i=this;return n.when(i.relative(t,e),function(e){return i.symbolicLink(t,e,r||"file")})},e.exists=function(e){return n.when(this.stat(e),function(){return!0},function(){return!1})},e.isFile=function(e){return n.when(this.stat(e),function(e){return e.isFile()},function(){return!1})},e.isDirectory=function(e){return n.when(this.stat(e),function(e){return e.isDirectory()},function(){return!1})},e.isSymbolicLink=function(e){return n.when(this.statLink(e),function(e){return e.isSymbolicLink()},function(){return!1})},e.lastModified=function(e){var t=this;return t.stat(e).invoke("lastModified")},e.lastAccessed=function(e){var t=this;return t.stat(e).invoke("lastAccessed")},e.absolute=function(e){return this.isAbsolute(e)?this.normal(e):this.join(t(),e)},e.relative=function(e,t){var r=this;return n.when(this.isDirectory(e),function(n){return n?r.relativeFromDirectory(e,t):r.relativeFromFile(e,t)})},e.relativeFromFile=function(e,t){var n=this;for(e=n.absolute(e),t=n.absolute(t),e=e.split(n.SEPARATORS_RE()),t=t.split(n.SEPARATORS_RE()),e.pop();e.length&&t.length&&t[0]==e[0];)e.shift(),t.shift();for(;e.length;)e.shift(),t.unshift("..");return t.join(n.SEPARATOR)},e.relativeFromDirectory=function(e,n){for(n||(n=e,e=t()),e=this.absolute(e),n=this.absolute(n),e=e.split(this.SEPARATORS_RE()),n=n.split(this.SEPARATORS_RE()),2===e.length&&""===e[1]&&e.pop();e.length&&n.length&&n[0]==e[0];)e.shift(),n.shift();for(;e.length;)e.shift(),n.unshift("..");return n.join(this.SEPARATOR)},e.contains=function(e,t){var n,r;if(e=this.absolute(e),t=this.absolute(t),e=e.split(this.SEPARATORS_RE()),t=t.split(this.SEPARATORS_RE()),2===e.length&&""===e[1]&&e.pop(),e.length>t.length)return!1;for(n=0,r=e.length;r>n&&e[n]===t[n];n++);return n==r},e.reroot=o,e.toObject=function(e){var t=this,r=t.listTree(e||"",function(e,t){return t.isFile()});return n.when(r,function(e){var r={};return n.all(e.map(function(e){return n.when(t.read(e,"rb"),function(t){r[e]=t})})).then(function(){return r})})},e.merge=function(e){var t,r={};return e.forEach(function(e){t=n.when(t,function(){return e.listTree("",function(e,t){return t.isFile()}).then(function(t){return n.all(t.map(function(t){return n.when(e.read(t,"rb"),function(e){r[t]=e})}))})})}),n.when(t,function(){return a(r)})},e.Stats=l;var u=["isDirectory","isFile","isBlockDevice","isCharacterDevice","isSymbolicLink","isFIFO","isSocket"];u.forEach(function(e){l.prototype[e]=function(){return this.node[e]()}}),l.prototype.lastModified=function(){return new Date(this.node.mtime)},l.prototype.lastAccessed=function(){return new Date(this.node.atime)}}}});