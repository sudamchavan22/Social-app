var Q=require("q"),URL=require("url2"),MimeTypes=require("mime"),FS=require("../fs"),StatusApps=require("./status"),RedirectApps=require("./redirect"),Negotiation=require("./negotiate"),HtmlApps=require("./html"),Deprecate=require("../deprecate");exports.File=function(e,t){return function(n){return exports.file(n,e+"",t)}},exports.FileTree=function(e,t){t||(t={}),t.notFound=t.notFound||StatusApps.notFound,t.file=t.file||exports.file,t.directory=t.directory||exports.directory,t.fs=t.fs||FS;var n=t.fs;return e=n.canonical(e),function(r,i){URL.parse(r.url),r.fs=n;var a=t.redirect||(r.permanent||t.permanent?RedirectApps.permanentRedirect:RedirectApps.temporaryRedirect);return Q.when(e,function(e){var s=n.join(e,r.pathInfo.slice(1));return Q.when(n.canonical(s),function(o){return t.followInsecureSymlinks&&(Deprecate.deprecationWarning("followInsecureSymlinks","followInsecureSymbolicLinks"),t.followInsecureSymbolicLinks=!0),n.contains(e,o)||t.followInsecureSymbolicLinks?s!==o&&t.redirectSymbolicLinks?a(r,n.relativeFromFile(s,o)):Q.when(n.stat(o),function(e){return e.isFile()?t.file(r,o,t.contentType,n):e.isDirectory()?t.directory(r,o,t.contentType,n):t.notFound(r,i)}):t.notFound(r,i)},function(){return t.notFound(r,i)})})}},exports.file=function(e,t,n,r){return r=r||FS,n=n||MimeTypes.lookup(t),Q.when(r.stat(t),function(i){var a,s=exports.etag(i),o={flags:"rb"},l=200,c={"content-type":n,etag:s};if("range"in e.headers)if("if-range"in e.headers&&s!=e.headers["if-range"]);else{if(a=interpretFirstRange(e.headers.range,i.size),!a)return StatusApps.responseForStatus(e,416);if(a.end>i.size&&(a.end=i.size),a.end<=a.begin)return StatusApps.responseForStatus(e,416);l=206,c["content-range"]="bytes "+a.begin+"-"+(a.end-1)+"/"+i.size,c["content-length"]=""+(a.end-a.begin),o.begin=a.begin,o.end=a.end}else{if(s==e.headers["if-none-match"])return StatusApps.responseForStatus(e,304);c["content-length"]=""+i.size}return{status:l,headers:c,body:r.open(t,o),file:t,range:a}})};var rangesExpression=/^\s*bytes\s*=\s*(\d*\s*-\s*\d*\s*(?:,\s*\d*\s*-\s*\d*\s*)*)$/,rangeExpression=/^\s*(\d*)\s*-\s*(\d*)\s*$/,interpretRange=function(e,t){var n=rangeExpression.exec(e);if(n&&(""!=n[1]||""!=n[2])){var r,i;return""==n[1]?(r=0,i=+n[2]+1):""==n[2]?(r=+n[1],i=t):(r=+n[1],i=+n[2]+1),{begin:r,end:i}}},interpretFirstRange=exports.interpretFirstRange=function(e,t){var n=rangesExpression.exec(e);if(n){for(var r=n[1].split(/\s*,\s*/),i=interpretRange(r[0],t),a=0,s=r.length;s>a;a++){var o=interpretRange(r[a],t);if(!(o.begin<=i.end))return;i.end=o.end}return i}};exports.etag=function(e){return[e.node.ino,e.size,e.lastModified().getTime()].join("-")},exports.directory=function(e,t){var n=StatusApps.notFound(e);return n.directory=t,n},exports.ListDirectories=function(e,t){return t=t||exports.listDirectory,function(n){if(n.directoryIndex)throw Error("DirectoryIndex must be used after ListDirectories");return n.listDirectories=!0,Q.fcall(e,n).then(function(e){return void 0!==e.directory?t(n,e):e})}},exports.listDirectory=function(e,t){if(e.location=URL.parse(e.path),e.location.file)return RedirectApps.redirect(e,e.location.file+"/");var n={};n["text/plain"]=exports.listDirectoryText,n["text/markdown"]=exports.listDirectoryMarkdown,e.handleHtmlFragmentResponse&&(n["text/html"]=exports.listDirectoryHtmlFragment),e.handleJsonResponse&&(n["application/json"]=exports.listDirectoryJson);var r=Negotiation.negotiate(e,n)||function(){return t};return r(e,t)},exports.listDirectoryHtmlFragment=function(e,t){return exports.listDirectoryData(e,t).then(function(e){return{status:200,headers:{"content-type":"text/html"},htmlTitle:"Directory Index",htmlFragment:{forEach:function(t){t('<ul class="directory-index">\n'),Object.keys(e).sort().forEach(function(n){var r=e[n],i="";"directory"===r.type&&(i="/"),t('    <li class="entry '+r.type+'"><a href="'+HtmlApps.escapeHtml(n+i)+'">'+HtmlApps.escapeHtml(n+i)+"</a></li>\n")}),t("</ul>\n")}}}})},exports.listDirectoryText=function(e,t){return exports.listDirectoryData(e,t).then(function(e){return{status:200,headers:{"content-type":"text/plain"},body:{forEach:function(t){Object.keys(e).sort().forEach(function(n){var r=e[n],i="";"directory"===r.type&&(i="/"),t(n+i+"\n")})}}}})},exports.listDirectoryMarkdown=function(e,t){return exports.listDirectoryData(e,t).then(function(e){return{status:200,headers:{"content-type":"text/plain"},body:{forEach:function(t){t("\n# Directory Index\n\n"),Object.keys(e).forEach(function(n){var r=e[n],i="";"directory"===r.type&&(i="/"),t("-   "+n+i+"\n")}),t("\n")}}}})},exports.listDirectoryJson=function(e,t){return exports.listDirectoryData(e,t).then(function(e){return{status:200,headers:{},data:e}})},exports.listDirectoryData=function(e,t){if(!e.fs)throw Error("Can't list a directory without a designated file system");var n=e.fs;return Q.invoke(n,"list",t.directory).then(function(e){return e.sort(),e.map(function(e){return Q.invoke(n,"stat",n.join(t.directory,e)).then(function(t){return t.isDirectory()?{name:e,stat:{type:"directory"}}:t.isFile()?{name:e,stat:{type:"file"}}:void 0},function(){})})}).all().then(function(e){var t={};return e.forEach(function(e){e&&(t[e.name]=e.stat)}),t})},exports.DirectoryIndex=function(e,t){return t=t||"index.html",function(n){return n.directoryIndex=!0,n.location=URL.parse(n.path),n.location.file===t?RedirectApps.redirect(n,"."):Q.fcall(e,n).then(function(r){if(void 0!==r.directory){if(n.location.file)return RedirectApps.redirect(n,n.location.file+"/");var i=n.fs.join(r.directory,t);return Q.invoke(n.fs,"isFile",i).then(function(i){return i?(n.url=URL.resolve(n.url,t),n.pathInfo+=t,e(n)):r})}return r})}};