var Q=require("q"),HTTP=require("../http"),RouteApps=require("./route"),StatusApps=require("./status");exports.Normalize=function(e){return function(t,n){var t=HTTP.normalizeRequest(t);return Q.when(e(t,n),function(e){return HTTP.normalizeResponse(e)})}},exports.Date=function(e,t){return t=t||function(){return new Date},RouteApps.Trap(e,function(e){e.headers.date=""+t()})},exports.Error=function(e,t){return function(n,r){return Q.when(e(n,r),null,function(e){return t||(e=void 0),StatusApps.responseForStatus(n,500,e&&e.stack||e)})}},exports.Debug=function(e){return exports.Error(e,!0)},exports.Log=function(e,t,n){return t=t||console.log,n=n||function(e){return(new Date).toISOString()+" "+e},function(r,i){var a=r.remoteHost+":"+r.remotePort,s=r.method+" "+r.path+" "+"HTTP/"+r.version.join(".");return t(n(a+" "+"-->     "+s)),Q.when(e(r,i),function(e){return e?t(n(a+" "+"<== "+e.status+" "+s+" "+(e.headers["content-length"]||"-"))):t(n(a+" "+"... "+"... "+s+" (response undefined / presumed streaming)")),e},function(e){return t(n(a+" "+"!!!     "+s+" "+(e&&e.message||e))),Q.reject(e)})}},exports.Time=function(e){return function(t,n){var r=new Date;return Q.when(e(t,n),function(e){var t=new Date;return e&&e.headers&&(e.headers["x-response-time"]=""+(t-r)),e})}},exports.Headers=function(e,t){return function(n,r){return Q.when(e(n,r),function(e){return e&&e.headers&&Object.keys(t).forEach(function(n){n in e.headers||(e.headers[n]=t[n])}),e})}};var farFuture=31536e7;exports.Permanent=function(e,t){return t=t||function(){return new Date((new Date).getTime()+farFuture)},e=RouteApps.Tap(e,function(e){e.permanent=t}),e=RouteApps.Trap(e,function(e){e.headers.expires=""+t()})},exports.Decorators=function(e,t){return e.reversed().forEach(function(e){t=e(t)}),t};