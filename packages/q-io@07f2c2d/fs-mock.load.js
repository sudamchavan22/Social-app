montageDefine("07f2c2d","fs-mock",{dependencies:["q","./fs-boot","./fs-common","./buffer-stream","./reader","collections/set","./fs"],factory:function(e,t,n){function r(e,t){return this instanceof r?(this._root=new o(this,"/"),h.update(this,function(){return t}),t=t||this.ROOT,e&&this._init(e),void 0):new r(e,t)}function i(e,t){return c.when(e.listTree(t),function(n){var i={};return c.all(n.map(function(n){var r=e.join(t,n),a=e.relativeFromDirectory(t,r);return c.when(e.stat(r),function(t){return t.isFile()?c.when(e.read(n,"rb"),function(e){i[a]=e}):void 0})})).then(function(){return r(i)})})}function a(e){if(!e)throw Error("FS required argument");this._fs=e,this.atime=this.mtime=Date.now(),this.mode=parseInt("0644",8),this._owner=null}function s(e){a.call(this,e),this._chunks=[]}function o(e){a.call(this,e),this._entries=Object.create(null),this.mode=parseInt("0755",8)}function l(e,t){a.call(this,e),this._link=t}var c=e("q"),u=e("./fs-boot"),h=e("./fs-common"),p=e("./buffer-stream"),d=e("./reader"),f=e("collections/set");n.exports=r,r.prototype=Object.create(u),r.prototype._init=function(e,t){t=t||this.ROOT,Object.keys(e).forEach(function(n){var r=e[n];n=this.join(t,n);var i=this.directory(n),a=this.base(n),o=this._root._walk(i,!0),l=new s(this);if(!(r instanceof Buffer)){if("object"==typeof r)return this._root._walk(n,!0),this._init(r,n),void 0;r=new Buffer(r+"","utf-8")}o._entries[a]=l,l._chunks=[r]},this)},r.prototype.list=function(e){var t=this;return c.fcall(function(){e=t.absolute(e);var n=t._root._walk(e)._follow(e);return n.isDirectory()||Error("Can't list non-directory: "+JSON.stringify(e)),Object.keys(n._entries).sort()})},r.prototype.open=function(e,t,n,r){var i=this;return c.fcall(function(){e=i.absolute(e);var a=i.directory(e),o=i.base(e),l=i._root._walk(a);if(!l.isDirectory())throw Error("Can't find "+e+" because "+a+" is not a directory");"object"==typeof t?(r=t,t=r.flags,n=r.charset):r=r||{},t=t||"r";var c=t.indexOf("b")>=0,u=t.indexOf("w")>=0,h=t.indexOf("a")>=0;if(c||(n=n||"utf-8"),u||h){l._entries[o]||(l._entries[o]=new s(this),"mode"in r&&(l._entries[o].mode=r.mode));var f=l._entries[o]._follow(e);if(!f.isFile())throw Error("Can't write non-file "+e);return f.mtime=Date.now(),f.atime=Date.now(),h||(f._chunks.length=0),new p(f._chunks,n)}if(!l._entries[o])throw Error("Can't read non-existant "+e);var f=l._entries[o]._follow(e);if(!f.isFile())throw Error("Can't read non-file "+e);return f.atime=Date.now(),"begin"in r&&"end"in r?new p([d.join(f._chunks).slice(r.begin,r.end)],n):new p(f._chunks,n)})},r.prototype.remove=function(e){var t=this;return c.fcall(function(){e=t.absolute(e);var n=t.directory(e),r=t.base(e),i=t._root._walk(n);if(!i.isDirectory())throw Error("Can't remove file from non-directory: "+e);if(!i._entries[r])throw Error("Can't remove non-existant file: "+e);if(i._entries[r].isDirectory())throw Error("Can't remove directory. Use removeDirectory: "+e);delete i._entries[r]})},r.prototype.makeDirectory=function(e,t){var n=this;return c.fcall(function(){e=n.absolute(e);var r=n.directory(e),i=n.base(e),a=n._root._walk(r);if(!a.isDirectory()){var s=Error("Can't make directory in non-directory: "+e);throw s.code="EEXISTS",s.exists=!0,s}if(a._entries[i]){var s=Error("Can't make directory. Entry exists: "+e);throw s.code="EISDIR",s.exists=!0,s.isDirectory=!0,s}a._entries[i]=new o(n),t&&(a._entries[i].mode=t)})},r.prototype.removeDirectory=function(e){var t=this;return c.fcall(function(){e=t.absolute(e);var n=t.directory(e),r=t.base(e),i=t._root._walk(n);if(!i.isDirectory())throw Error("Can't remove directory from non-directory: "+e);if(!i._entries[r])throw Error("Can't remove non-existant directory: "+e);if(!i._entries[r].isDirectory())throw Error("Can't remove non-directory: "+e);delete i._entries[r]})},r.prototype.stat=function(e){var t=this;return c.fcall(function(){return e=t.absolute(e),new t.Stats(t._root._walk(e)._follow(e))})},r.prototype.statLink=function(e){var t=this;return c.fcall(function(){return e=t.absolute(e),new t.Stats(t._root._walk(e))})},r.prototype.link=function(e,t){var n=this;return c.fcall(function(){e=n.absolute(e),t=n.absolute(t);var r=n._root._walk(e)._follow(e);if(!r.isFile())throw Error("Can't link non-file: "+e);var i=n.directory(t),a=n.base(t),s=n._root._walk(i)._follow(i);if(!s.isDirectory())throw Error("Can't create link in non-directory: "+t);if(s._entries[a]&&s._entries[a].isDirectory())throw Error("Can't overwrite existing directory with hard link: "+t);s._entries[a]=r})},r.prototype.symbolicLink=function(e,t){var n=this;return c.fcall(function(){e=n.absolute(e);var r=n.directory(e),i=n.base(e),a=n._root._walk(r);if(a._entries[i]&&a._entries[i].isDirectory())throw Error("Can't overwrite existing directory with symbolic link: "+e);a._entries[i]=new l(n,t)})},r.prototype.chown=function(e,t){var n=this;return c.fcall(function(){e=n.absolute(e),n._root._walk(e)._follow(e)._owner=t})},r.prototype.chmod=function(e,t){var n=this;return c.fcall(function(){e=n.absolute(e),n._root._walk(e)._follow(e).mode=t})},r.prototype.rename=function(e,t){var n=this;return c.fcall(function(){e=n.absolute(e),t=n.absolute(t);var r=n.directory(e),i=n._root._walk(r)._follow(r),a=n.base(e),s=i._entries[a];if(!s){var o=Error("Can't copy non-existent file: "+e);throw o.code="ENOENT",o}if(s=s._follow(e),!s){var o=Error("Can't copy non-existent file: "+e);throw o.code="ENOENT",o}var l=n.directory(t),c=n._root._walk(l)._follow(l),u=n.base(t),h=c._entries[u];if(h&&(h=h._follow(t)),h&&h.isDirectory()){var o=Error("Can't copy over existing directory: "+t);throw o.code="EISDIR",o}h!==s&&(c._entries[u]=s,delete i._entries[a])})},r.prototype.readLink=function(e){var t=this;return c.fcall(function(){e=t.absolute(e);var n=t._root._walk(e);if(!t.isSymbolicLink())throw Error("Can't read non-symbolic link: "+e);return n._link})},r.prototype.canonical=function(e){var t=this;return c.fcall(function(){return e=t.absolute(e),t._root._canonical(e)})},r.mock=i,a.prototype._walk=function(e,t,n){var r=this._fs.split(e);return this._fs.isAbsolute(e)?(r.shift(),this._fs._root._walkParts(r,t,this._fs.ROOT)):this._walkParts(r,t,n||this._fs.ROOT)},a.prototype._walkParts=function(e,t,n){if(0===e.length)return this;var r=e.shift();if(""===r)return this._walkParts(e,t,this._fs.join(n,r));var i=Error("Can't find "+JSON.stringify(this._fs.resolve(r,this._fs.join(e)))+" via "+JSON.stringify(n));throw i.code="ENOENT",i},a.prototype._canonical=function(e){if(!this._fs.isAbsolute(e))throw Error("Path must be absolute for _canonical: "+e);var t=this._fs.split(e);t.shift();var n=this._fs.ROOT;return n+this._fs._root._canonicalParts(t,n)},a.prototype._canonicalParts=function(e,t){return 0===e.length?t:this._fs.join(t,this._fs.join(e))},a.prototype._follow=function(){return this},a.prototype._touch=function(){this.mtime=Date.now()};var g=["isDirectory","isFile","isBlockDevice","isCharacterDevice","isSymbolicLink","isFIFO","isSocket"];g.forEach(function(e){a.prototype[e]=function(){return!1}}),a.prototype.lastAccessed=function(){return this.atime},a.prototype.lastModified=function(){return this.mtime},s.prototype=Object.create(a.prototype),s.prototype.isFile=function(){return!0},Object.defineProperty(s.prototype,"size",{configurable:!0,enumerable:!0,get:function(){return this._chunks.reduce(function(e,t){return e+=t.length},0)}}),o.prototype=Object.create(a.prototype),o.prototype.isDirectory=function(){return!0},o.prototype._walkParts=function(e,t,n){if(n=n||this._fs.ROOT,0===e.length)return this;var r=e.shift();if(""===r)return this._walkParts(e,t,this._fs.join(n,r));if(!this._entries[r]){if(!t){var i=Error("Can't find "+JSON.stringify(this._fs.join(e))+" via "+JSON.stringify(n));throw i.code="ENOENT",i}this._entries[r]=new o(this._fs)}return this._entries[r]._walkParts(e,t,this._fs.join(n,r))},o.prototype._canonicalParts=function(e,t){if(0===e.length)return t;var n=e.shift();return""===n?t:(t===this._fs.ROOT&&(t=""),this._entries[n]?this._entries[n]._canonicalParts(e,this._fs.join(t,n)):this._fs.join(t,n,this._fs.join(e)))},l.prototype=Object.create(a.prototype),l.prototype.isSymbolicLink=function(){return!0},l.prototype._follow=function(e,t){if(t=t||f(),t.has(this)){var n=Error("Can't follow symbolic link cycle at "+JSON.stringify(e));throw n.code="ELOOP",n}t.add(this);var r=this._fs.join(e,"..",this._link);return this._walk(r,null,"<link>")._follow(r,t)},l.prototype._canonicalParts=function(e,t){return this._fs.relativeFromDirectory(this._fs.ROOT,this._fs._root._canonical(this._fs.absolute(this._fs.join(t,"..",this._link))))},e("./fs")}});